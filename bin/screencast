#!/bin/sh
#
# https://www.romanzolotarev.com/bin/screenshot
# Copyright 2018 Roman Zolotarev <hi@romanzolotarev.com>
#
# pkg_add slop ffmpeg mpv

set -e
debug_log='/tmp/screencast.debug.log'
log='/tmp/screencast.log'
trap 'clean_up' EXIT
trap exit HUP INT TERM

clean_up() {
  echo "$(date) clean up">>"$debug_log"
  [ -f "$log" ] && { cat "$log" >> "$debug_log"; rm "$log"; }
  [ -f "$output" ] && { stat -f '%z bytes' "$output"; mpv --really-quiet "$output"; }
}

case $1 in

start)
  echo "$(date) start">>"$debug_log"
  area=$(slop -o -f '%x,%y+%wx%h')
  origin=$(echo "$area"|cut -d'+' -f1)
  odd_size=$(echo "$area"|cut -d'+' -f2)
  # width and height should be divisible by two
  w=$(( $(echo "$odd_size"|cut -d'x' -f1) / 2 * 2))
  h=$(( $(echo "$odd_size"|cut -d'x' -f2) / 2 * 2))
  size="${w}x${h}"
  echo "$(date) $odd_size -> $size">>"$debug_log"
  input=":0.0+$origin"
  output="$HOME/downloads/$(date +%Y%m%d-%H%M%S)-$size.mp4"
  echo "$(date) DISPLAY=$DISPLAY">>"$debug_log"
  echo "$(date) capturing $size from $input to $output" >> "$debug_log"
  echo "$(date) ffmpeg">>"$debug_log"
  ffmpeg -f x11grab -r 30 -s "$size" -i "$input" \
    -preset veryslow \
    -pix_fmt yuv420p \
    -hide_banner \
    -movflags +faststart \
    -tune animation \
    -vcodec h264 "$output" 2> "$log"
  ;;

stop)
  echo "$(date) stop">>"$debug_log"
  pgrep -q ffmpeg || { echo "$(date) nothing to stop" >> "$debug_log"; exit 1; }
  pkill ffmpeg && 
    echo "$(date) stopped">>"$debug_log" ||
    echo "$(date) failed to stop">>"$debug_log"
  ;;

*)
  echo 'usage: screenshot start'
  echo '                | stop'
  exit 1
  ;;

esac
