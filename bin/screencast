#!/bin/sh
#
# https://www.romanzolotarev.com/bin/screenshot
# Copyright 2018 Roman Zolotarev <hi@romanzolotarev.com>
#
# pkg_add slop ffmpeg mpv

movie() {
  size=$1
  input=$2
  log='/tmp/screencast.log'
  output="$HOME/downloads/$(date +%Y%m%d-%H%M%S)-$size.mp4"
  printf 'capturing to %s ' "$output"
  aucat -i "$HOME/src/www/clear.wav"
  ffmpeg -f x11grab -r 30 -s "$size" -i "$input" \
    -preset veryslow \
    -pix_fmt yuv420p \
    -hide_banner \
    -movflags +faststart \
    -tune animation \
    -vcodec h264 "$output" 2> "$log"
  cat "$log"
  rm "$log"
  stat -f '%z bytes' "$output"
  mpv --really-quiet "$output" &
  aucat -i "$HOME/src/www/quits.wav"
}

case $1 in

l) movie '976x1080' ':0.0+0,0';;
r) movie '944x1080' ':0.0+976,0';;
start)
  set -e
  area=$(slop -o)
  size=$(echo "$area"|cut -d'+' -f1)
  input=":0.0+$(echo "$area"|cut -d'+' -f2-|tr '+' ',')"
  set +e
  movie "$size" "$input"
  ;;

stop)
  aucat -i "$HOME/src/www/thats_it.wav"
  pgrep -q ffmpeg || { echo 'nothing to stop'; exit 1; }
  pkill ffmpeg
  ;;

*)
  echo 'usage: screenshot start'
  echo '                | stop'
  echo '                | l'
  echo '                | r'
  exit 1
  ;;

esac
