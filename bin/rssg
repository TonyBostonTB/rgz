#!/bin/sh
set -e


main () {
	test -n "$1" || usage
	test -f "$1" || no_file "$1"
	index_html_file="$1"

	base="$(dirname "$(readlink -f "$index_html_file")")"
	base_url="$(
			get_url "$(
				cat "$index_html_file"
			)" | sed 's#\(.*\)/[^/]*#\1#'
	)"

	get_items "$(cat "$index_html_file")" |
	render_items "$base" "$base_url" |
	render_feed "$index_html_file"
}


usage() {
	echo "usage: ${0##*/} index.html > rss.xml" >&2
	exit 1
}


no_file() {
	echo "${0##*/}: $1: No such file" >&2
	exit 2
}


get_title() {
	echo "$1" | grep -i '^<h1' | head -1 |
	sed 's#.*>\(.*\)<.*#\1#'
}


get_email() {
	echo "$1" | grep -i 'mailto:' | head -1 |
	sed 's/.*href="mailto:\(.*\)".*/\1/'
}


get_name() {
	echo "$1" | grep -i 'mailto:' | head -1 |
	sed 's#.*>\(.*\)<.*#\1#'
}


get_url() {
	echo "$1" | grep -i '<a .*rss' | head -1 |
	sed 's#.*href="\(.*\)".*#\1#'
}


get_items() {
	echo "$1" | grep -i 'href=".*" title="' |
	sed 's#.*href="\(.*\)" title="\(.*\)">\(.*\)</a>.*#\1 \2 \3#'
}


get_description() {
	echo "$1" |
	awk -v s='[[:space:]]' 'sub("^.*<"s"*[Pp]("s"[^>]*)?>",""),sub("</"s"*[Pp]"s"*>.*","")&&x=1;x{exit}'
}


render_items() {
	while read -r i
	do render_item "$1" "$2" "$i"
	done
}


format_text() {
	sed 's/\&nbsp;/ /g' | grep -vi '<h1>'
}


rel_to_abs_urls() {
	href='s#href="#href="'"$1"'/#g'
	href='s#href=/"#href="'"$1"'/#g'
	src='s#src="#src="'"$1"'/#g'
	sed "$href;$src"
}


date_rfc_822() {
	date -j '+%a, %d %b %Y %H:%M:%S %z' \
	"$(echo "$1"| tr -cd '[:digit:]')0000"
}


render_item() {
	base="$1"
	base_url="$2"
	item="$3"
	cur_path="$(dirname "$3")"
	echo base="$1"
	echo base_url="$2"
	echo item="$3"
	echo cur_path="$(dirname "$3")"

	file=$(echo "$item"|awk '{print$1}')
	date=$(echo "$item"|awk '{print$2}')
	url="/$file"
	description=$(rel_to_abs_urls "$base_url" "$cur_path" < "$base/$file" | format_text)
	title=$(get_title "$description")

	cat <<-EOF

	<item>
	<guid>$base_url$url</guid>
	<link>$base_url$url</link>
	<pubDate>$(date_rfc_822 "$date")</pubDate>
	<title>$title</title>
	<description><![CDATA[

	$description

	]]></description>
	</item>
	EOF
}


render_feed() {
	index_html_file="$1"
	html=$(cat "$index_html_file")
	base="$(dirname "$(readlink -f "$index_html_file")")"
	title=$(get_title "$html")
	description=$(get_description "$html")
	email=$(get_email "$html")
	name=$(get_name "$html")
	url=$(get_url "$html")
	base_url="$(echo "$url" | cut -d '/' -f1-3)"

	cat <<-EOF
	<?xml version="1.0" encoding="UTF-8"?>
	<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
	<atom:link href="$url" rel="self" type="application/rss+xml" />
	<title>$title</title>
	<description>$description</description>
	<link>$base_url/</link>
	<lastBuildDate>$(date_rfc_822 date)</lastBuildDate>
	<managingEditor>$email ($name)</managingEditor>
	$(cat)
	</channel></rss>
	EOF
}

main "$@"
