#!/bin/sh
set -e


main () {
	test -n "$1" || usage
	test -n "$2" || usage
	test -n "$3" || usage
	test -n "$4" || usage
	test -n "$5" || usage
	test -f "$5" || no_file "$5"

	title="$1"
	desc="$2"
	author="$3"
	url="$4"
	items="$5"

	base="$(dirname "$(readlink -f "$items")")"
	base_url="$(echo "$url" | cut -d '/' -f1-3)"

	render_items "$base" "$base_url" < "$items" |
	render_feed "$title" "$desc" "$author" "$url"
}

usage() {
	echo "usage: ${0##*/} title description author url items.txt > rss.xml" >&2
	exit 1
}

no_file() {
	echo "${0##*/}: $1: No such file" >&2
	exit 2
}

render_items() {
	while read -r i
	do render_item "$1" "$2" "$i"
	done
}


render_item() {
	base="$1"
	base_url="$2"
	item="$3"
	cur_path="$(dirname "$3")"

	date=$(echo "$item"|awk '{print$1}')
	echo "$date"
	file=$(echo "$item"|awk '{print$2}')
	url="/$file"
	description=$(rel_to_abs_urls "$base_url" "$cur_path" < "$base/$file" | format_text)
	title=$(echo "$description" | grep '^<h1' | head -1 | sed 's/<[^>]*>//g')

	cat <<-EOF

	<item>
	<guid>$base_url$url</guid>
	<link>$base_url$url</link>
	<pubDate>20 Sep 2018 00:00:00 +0000</pubDate>
	<title>$title</title>
	<description><![CDATA[

	$description

	]]></description>
	</item>
	EOF
}


format_text() {
	sed 's/\&nbsp;/ /g'
}


rel_to_abs_urls() {
	href='s#href="#href="'"$1"'/#g'
	href='s#href=/"#href="'"$1"'/#g'
	src='s#src="#src="'"$1"'/#g'
	sed "$href;$src"
}


render_feed() {
	title="$1"
	desc="$2"
	author="$3"
	url="$4"
	base_url="$(echo "$url" | cut -d '/' -f1-3)"

	date_rfc_822=$(stat -f%Sm -t "%a, %d %b %Y %H:%M:%S %z" "$0")

	cat <<-EOF
	<?xml version="1.0" encoding="UTF-8"?>
	<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
	<atom:link href="$url" rel="self" type="application/rss+xml" />
	<title>$title</title>
	<description>$desc</description>
	<link>$base_url/</link>
	<lastBuildDate>$date_rfc_822</lastBuildDate>
	<managingEditor>$author</managingEditor>
	$(cat)
	</channel></rss>
	EOF
}

main "$@"
