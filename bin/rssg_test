#!/bin/sh

program="$(dirname "$(readlink -f "$0")")/rssg"

total=0; nos=0
no() { total=$((total+1)); echo "no ok $total - $1"; nos=$((nos+1)); }
ok() { total=$((total+1)); echo "ok $total - $1"; }
eq() { if [ "$1" = "$2" ]; then ok "$3"; else no "$3"
	printf '\033[32m%s\n\033[31m%s\n\033[m' "$1" "$2"; fi; }
desc() { printf '#\n\033[1m%s\033[m\n' "$1"; }

##########################################################################


desc 'args'

usage='usage: rssg title description author url items.txt > rss.xml'

err=$(2>&1 "$program")
eq "$err" "$usage" 'no args'

desc 'out'

temp=$(mktemp -d)

cat > "$temp/items.txt" << EOF
2018-09-17 2018-09-17.html
2018-08-26 2018-08-26.html
EOF

model=$(cat << EOF
EOF
)

cat > "$temp/2018-08-26.html" << EOF
<h1>title1</h1>

<p>desc1</p>

<p>
<a href="2018-09-17.html">rel</a><br>
<a href="/n/2018-09-17.html">abs path</a><br>
<a href="/n/">dir</a><br>
<a href="https://www/n/">full</a><br>
</p>
EOF
cat > "$temp/2018-09-17.html" << EOF
<h1>title2</h1>

<p>desc2</p>
EOF

"$program" 'Newletter' 'Monthly updates' 'Roman' 'https://www/rss.xml' "$temp/items.txt" > "$temp/rss.xml"

out=$(sed 's#Date>.*</#Date>XXX, XX XXX XXXX XX:XX:XX +XXXX<#' \
"$temp/rss.xml")

eq "$model" "$out" ''


rm -rf "${temp:?}"


##########################################################################

echo "1..$total"
if [ "$nos" -gt 0 ]; then echo "FAILED $nos/$total"; else echo "PASS"; fi
