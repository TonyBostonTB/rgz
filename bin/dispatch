#!/bin/sh -e

CHROOT='/var/www'
DB='/db/www'
EXP_TIME='3600'
FROM='hi@romanzolotarev.com'
NAME='Roman Zolotarev'

MAIL_QUEUE="${CHROOT}$DB/mail_queue"
TOKENS="${CHROOT}$DB/tokens"
CUSTOMERS="${CHROOT}$DB/customers"


# base64() { echo "=?utf-8?B?$(echo "$1"|b64encode /dev/stdin|sed '1d;$d')?="; }
test -d "$MAIL_QUEUE" &&
find "${MAIL_QUEUE}" -type f | head -n 100 |
while read -r message
do
	test -f "$message" || break
	# sendmail -t -F "$(base64 "$NAME")" -f "$FROM" < "$message"
	sendmail -t -F "$NAME" -f "$FROM" < "$message"
	head -n 1 "$message"
	rm -v "$message"
done


test -d "$TOKENS" &&
find "$TOKENS" -type f -cmin "+$(( EXP_TIME / 60 ))" -delete


if test -d "$CUSTOMERS"
then
	now=$(date +%s)
	find "$CUSTOMERS" -type f -name 'expires_at' |
	while read -r f
	do
		e_at=$(cat "$f")
		e_in=$((e_at - now))
		echo "${f%%/expires_at}: $e_at - $now = $e_in"
		test "$e_in" -lt 0 && rm -v "${f:?}"
	done
fi
