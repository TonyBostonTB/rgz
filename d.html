<style>
  #addForm {
    display: flex;
    flex-flow: row wrap;
    align-items: center;
  }
</style>

<div id="dates"></div>

<div id="addForm">
  <input type="date" id="addDateInput" required />
  <button type="submit" id="addSubmitButton">add date</button>
</div>

<script type="module" src="/test.js"></script>
<script type="module">
  import { test, is } from "/test.js";
  (({ datesDiv, addDateInput, addSubmitButton }) => {
    const toIso = (x) => {
      try {
        return new Date(x).toISOString();
      } catch {
        return null;
      }
    };
    const toDay = (x) => x !== null && new Date(x).toLocaleString();
    const diff = (now) => (x) => new Date(x) - now;
    const countDays = (ms) => Math.round(ms / 1000 / 60 / 60 / 24);
    const countHours = (ms) => Math.round(ms / 1000 / 60 / 60);
    const countMinutes = (ms) => Math.round(ms / 1000 / 60);
    const countSeconds = (ms) => Math.round(ms / 1000);
    const abs = (x) =>
      typeof x === "number" ? Math.abs(x).toLocaleString() : null;

    const addUnits = (article, singular, plural, x) => {
      if (x > 1) return `in&nbsp;${abs(x)}&nbsp;${plural}`;
      if (x === 1) return `in&nbsp;${article}&nbsp;${singular}`;
      if (x === 0) return `this&nbsp;${singular}`;
      if (x === -1) return `${article}&nbsp;${singular}&nbsp;ago`;
      return `${abs(x)}&nbsp;${plural}&nbsp;ago`;
    };

    const format = ({ time, iso, day, s, m, h, d }) => {
      console.log({ s, m, h, d });
      if (iso === null) return `${time} &mdash; invalid date`;
      if (s < 60 && s > -60)
        return `${day} &mdash;&nbsp;${addUnits("a", "second", "seconds", s)}`;
      if (m < 60 && h > -60)
        return `${day} &mdash;&nbsp;${addUnits("a", "minute", "minutes", m)}`;
      if (h < 24 && h > -24)
        return `${day} &mdash;&nbsp;${addUnits("an", "hour", "hours", h)}`;
      return `${day} &mdash;&nbsp;${addUnits("a", "day", "days", d)}`;
    };

    const update = (fn, p, n) => (x) => ({ ...x, [n]: fn(x[p]) });

    const compute = (now, dates) =>
      dates
        .map((x) => ({ time: x }))
        .map(update(toIso, "time", "iso"))
        .map(update(toDay, "iso", "day"))
        .map(update(diff(now), "iso", "ms"))
        .map(update(countDays, "ms", "d"))
        .map(update(countHours, "ms", "h"))
        .map(update(countMinutes, "ms", "m"))
        .map(update(countSeconds, "ms", "s"))
        .map(format)
        .join("<br>\n");

    const getUrlParams = () => new URLSearchParams(location.search);
    const getDates = () => getUrlParams().getAll("d");

    const render = () =>
      (datesDiv.innerHTML = `<p>${compute(new Date(), getDates())}`);

    // render and update

    render();
    setInterval(render, 1000);

    // add date input
    let addDateValue = new Date().toJSON();
    console.log(addDateValue);

    const changeDate = ({ target: { value } }) => (addDateValue = value);
    const addDateAndTime = () => addDate(addDateValue);

    const addDate = (value) => {
      const d = new Date(value).toString();
      if (d === "Invalid Date") {
        console.log("failed to add date");
        return;
      }
      const newUrlParams = getUrlParams();
      newUrlParams.append("d", value);
      const newUrl = location.origin + location.pathname + "?" + newUrlParams;
      location.href = newUrl;
    };

    addDateInput.addEventListener("change", changeDate);
    addSubmitButton.addEventListener("click", addDateAndTime);

    // tests

    /*
    test("compute()", () => {
      const now = new Date("2022-05-16T00:00Z");
      is(compute(now, []), "");
      is(compute(now, ["2022-"]), "2022- &mdash; invalid date");
      is(
        compute(now, ["2022-05-14", "2022-05-16"]),
        "2022-05-14 &mdash; 2 days ago<br>\n2022-05-16 &mdash; this hour"
      );
      is(compute(now, ["2022-05-14T00:00Z"]), "2022-05-14 &mdash; 2 days ago");
      is(compute(now, ["2022-05-15T00:00Z"]), "2022-05-15 &mdash; a day ago");
      is(compute(now, ["2022-05-15T22:00Z"]), "2022-05-15 &mdash; 2 hours ago");
      is(compute(now, ["2022-05-15T23:00Z"]), "2022-05-15 &mdash; an hour ago");
      is(compute(now, ["2022-05-16T00:00Z"]), "2022-05-16 &mdash; this hour");
      is(compute(now, ["2022-05-16T01:00Z"]), "2022-05-16 &mdash; in an hour");
      is(compute(now, ["2022-05-16T02:00Z"]), "2022-05-16 &mdash; in 2 hours");
      is(compute(now, ["2022-05-17T00:00Z"]), "2022-05-17 &mdash; in a day");
      is(compute(now, ["2022-05-18T00:00Z"]), "2022-05-18 &mdash; in 2 days");
    });
    */
  })({
    datesDiv: document.querySelector("#dates"),
    addDateInput: document.querySelector("#addDateInput"),
    addSubmitButton: document.querySelector("#addSubmitButton"),
  });
</script>
