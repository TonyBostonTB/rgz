<!DOCTYPE html><html lang="en">
<head><title>Configure YubiKey for login and SSH on OpenBSD - Roman Zolotarev</title><meta charset="utf-8"><meta name="referrer" content="no-referrer"><link rel="stylesheet" href="/styles.css"><link rel="manifest" href="/manifest.webmanifest"><meta name="theme-color" content="#ffffff"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
</head>
<body><script>!function(t){ t.addEventListener('DOMContentLoaded', function () { var l = t.querySelector('#light-off'); if (l === null) { console.log('Lights-out...'); } else { l.checked = t.cookie.match(/lightOff=true/) !== null; l.addEventListener('change', function () { t.cookie = 'lightOff=' + JSON.stringify(l.checked) + ';path=/'; }); } })}(document);</script><input class="light-off" type="checkbox" id="light-off">
<div class="page">
<div class="header"><div class="header__home"><a href="/">Home</a> - <a href="https://twitter.com/romanzolotarev">Twitter</a></div><div class="header__light-off"><label for="light-off" class="light-off-button"></label></div></div>
<div class="article"><h1 id="Configure%20YubiKey%20for%20login%20and%20SSH%20on%20OpenBSD">Configure YubiKey for login and SSH on OpenBSD</h1>

<p>Make sure OpenBSD 6.2 is installed on your computer, you&#8217;re <code>root</code>, and
you have at least one YubiKey. First of all, install and start <strong>YubiKey
Personalization Tool</strong>:</p>

<pre><code># pkg_add yubikey-personalization-gui
# yubikey-personalization-gui
</code></pre>

<p>Insert your YubiKey into USB port. Click <strong>Yubico OTP</strong>, then <strong>Quick</strong>.
Select <strong>Configuration Slot 1</strong> or <strong>2</strong>. Click <strong>Write Configuration</strong>.
Important: save the log into <code>/tmp/log</code>. Click <strong>Exit</strong>.</p>

<p>Extract <em>uid</em> and <em>key</em> from the log, verify <code>/var/db/yubikey/*</code> files, and
remove the log.</p>

<pre><code># cd /var/db/yubikey
# grep Yubico /tmp/log | cut -f5 -d,&gt;$(whoami).uid
# grep Yubico /tmp/log | cut -f6 -d,&gt;$(whoami).key
# chown root:auth $(whoami).*
# chmod 440 $(whoami).*
# cat $(whoami).*
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxx
# rm /tmp/log
# rm $(whoami).ctr # reset the counter, if present
</code></pre>

<p>Change <code>auth-defaults</code> in <code>/etc/login.conf</code>:</p>

<pre><code>auth-defaults:auth=yubikey,passwd:
</code></pre>

<p>Update <code>/etc/ssh/sshd_config</code>:</p>

<pre><code>PermitRootLogin yes
AuthenticationMethods publickey,password
PasswordAuthentication yes
</code></pre>

<p>Restart sshd, verify, and reboot:</p>

<pre><code># rcctl restart sshd
# ssh root@localhost
root@localhost&#39;s password:
Last login: Fri Mar 30 12:36:23 2018
OpenBSD 6.2 (GENERIC.MP) #7: Sat Mar 17 21:38:36 CET 2018

Welcome to OpenBSD: The proactively secure Unix-like operating system.

Please use the sendbug(1) utility to report bugs in the system.
Before reporting a bug, please try to reproduce it with the latest
version of the code. With bug reports, please try to ensure that
enough information to reproduce the problem is enclosed, and if a
known fix for it exists, include that as well.

# exit
# reboot
</code></pre>

<h2 id="See%20also">See also</h2>

<p><a href="http://man.openbsd.com/login.conf.5">login.conf(5)</a>,
<a href="http://man.openbsd.com/login_yubikey.8">login_yubikey(8)</a>,
<a href="https://github.com/Yubico/yubikey-personalization-gui">YubiKey Personalization GUI</a>,
<a href="https://www.yubico.com/store/">Yubico Store</a></p></div>
<div class="footer">&copy; <a href="/">Roman Zolotarev</a></div>
</div></body></html>
